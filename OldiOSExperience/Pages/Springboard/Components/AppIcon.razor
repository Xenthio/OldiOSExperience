@using OldiOSExperience.Data
@using OldiOSExperience.Services
@using Microsoft.JSInterop
@inject AnimationService AnimationService
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="app-icon @GetAnimationClass()" 
     style="@GetAnimationStyle()"
     @ref="iconElement"
     @onclick="HandleClick">
    <img src="@App.IconPath" alt="@App.Name" />
    <span>@App.Name</span>
</div>

@code {
    [Parameter]
    public required AppInfo App { get; set; }
    
    [Parameter]
    public EventCallback<AppInfo> OnAppClick { get; set; }
    
    [Parameter]
    public bool IsInDock { get; set; } = false;
    
    private ElementReference iconElement;
    private double iconCenterX = 0;
    private double iconCenterY = 0;
    
    // Cached animation style to avoid recalculating on every render
    private string cachedAnimationStyle = "";
    
    protected override void OnInitialized()
    {
        AnimationService.OnAnimationStateChanged += HandleAnimationStateChanged;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CaptureIconPosition();
        }
    }
    
    private async Task CaptureIconPosition()
    {
        try
        {
            var rect = await JSRuntime.InvokeAsync<BoundingRect>("getElementBoundingRect", iconElement);
            iconCenterX = rect.Left + rect.Width / 2;
            iconCenterY = rect.Top + rect.Height / 2;
        }
        catch (JSException)
        {
            // JavaScript interop failed - element may not be rendered yet
            // Position will be recaptured on next render or click
            iconCenterX = 0;
            iconCenterY = 0;
        }
        catch (TaskCanceledException)
        {
            // Operation was cancelled - likely component disposed
            iconCenterX = 0;
            iconCenterY = 0;
        }
    }
    
    private async Task HandleClick()
    {
        // Capture the icon position for fly-away calculations
        await CaptureIconPosition();
        
        // iOS 5/6: Always animate from screen center
        // App zooms in from center, icons fly away from center
        AnimationService.StartOpeningAnimation(
            AnimationService.SCREEN_CENTER_X, 
            AnimationService.SCREEN_CENTER_Y);
        
        await OnAppClick.InvokeAsync(App);
    }
    
    private void HandleAnimationStateChanged()
    {
        // Recalculate animation style when animation state changes
        cachedAnimationStyle = CalculateAnimationStyle();
        StateHasChanged();
    }
    
    private string GetAnimationClass()
    {
        if (!AnimationService.IsAnimating) return "";
        
        return AnimationService.CurrentState switch
        {
            AnimationState.Opening => "fly-away",
            AnimationState.Closing => "fly-back",
            _ => ""
        };
    }
    
    private string GetAnimationStyle()
    {
        // Return cached style to avoid recalculating on every render
        return cachedAnimationStyle;
    }
    
    private string CalculateAnimationStyle()
    {
        if (!AnimationService.IsAnimating || iconCenterX == 0) return "";
        
        // Calculate distance and direction from the animation center point
        double deltaX = iconCenterX - AnimationService.CenterX;
        double deltaY = iconCenterY - AnimationService.CenterY;
        double distance = Math.Sqrt(deltaX * deltaX + deltaY * deltaY);
        
        // Normalize to get direction
        double directionX = distance > 0 ? deltaX / distance : 0;
        double directionY = distance > 0 ? deltaY / distance : 0;
        
        // Fly away distance increases with distance from center
        double flyDistance = Math.Min(distance * 2, 800);
        
        // Both opening and closing use the same CSS custom properties
        return $"--fly-x: {flyDistance * directionX}px; --fly-y: {flyDistance * directionY}px;";
    }
    
    public void Dispose()
    {
        AnimationService.OnAnimationStateChanged -= HandleAnimationStateChanged;
    }
}