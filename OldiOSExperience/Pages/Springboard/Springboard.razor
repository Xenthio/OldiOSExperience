@using OldiOSExperience.Models
@using OldiOSExperience.Services
@inject SpringboardService SpringboardService
@inject BackgroundAppManager AppManager
@inject AnimationService AnimationService
@implements IDisposable

<div class="springboard-container @(isAppOpen ? "app-is-open" : "") @(isAppSwitcherVisible ? "switcher-visible" : "") @(debugAnimationActive ? "debug-animation" : "") @(isLocked ? "locked" : "") @(isUnlocking ? "unlocking" : "")">
    <!-- Wallpaper -->
    <div class="wallpaper" alt="Wallpaper"/>

    <!-- Debug Animation Toggle Button -->
    <button class="debug-animation-button" @onclick="ToggleDebugAnimation">
        @(debugAnimationActive ? "Hide Icons" : "Show Icons")
    </button>

    <!-- Status Bar -->
    <OldiOSExperience.System.StatusBar Style="OldiOSExperience.System.StatusBarStyle.WhiteOnBlackEtch" />

    <!-- Pages Container (the part that swipes) -->
    <div class="springboard-pages-container"
         @ontouchstart="HandleTouchStart"
         @ontouchmove="HandleTouchMove"
         @ontouchend="HandleTouchEnd"
         @onmousedown="HandleMouseDown"
         @onmousemove="HandleMouseMove"
         @onmouseup="HandleMouseUp"
         @onmouseleave="HandleMouseUp">
        
        <div class="springboard-pages-filmstrip" style="@filmstripStyle">
            <!-- Spotlight Page (index -1) -->
            <div class="springboard-page spotlight-container">
                <OldiOSExperience.Pages.Springboard.Components.Spotlight AllApps="AllApps" />
            </div>
            
            <!-- Regular App Pages -->
            @foreach (var page in Pages)
            {
                <div class="springboard-page">
                    @foreach (var app in page)
                    {
                        <OldiOSExperience.Pages.Springboard.Components.AppIcon App="app" OnAppClick="HandleAppClick" />
                    }
                </div>
            }
        </div>
    </div>

    <!-- Page Indicator Dots -->
    <div class="page-indicator">
        @for (int i = 0; i < Pages.Count; i++)
        {
            <div class="dot @(i == currentPageIndex ? "active" : "")"></div>
        }
    </div>

    <!-- The Dock -->
    <div class="dock">
        <div class="dock-background"></div>
        <div class="dock-icons">
            @foreach (var app in DockApps)
            {
                <OldiOSExperience.Pages.Springboard.Components.AppIcon App="app" OnAppClick="HandleAppClick" />
            }
        </div>
    </div>
    
    <!-- App Container for launching apps -->
    <OldiOSExperience.Pages.Springboard.Components.AppContainer CurrentApp="@openedApp" OnClose="CloseApp" />
    
    <!-- App Switcher (multitasking tray) -->
    <OldiOSExperience.Pages.Springboard.Components.AppSwitcher IsVisible="@isAppSwitcherVisible" 
                                          OnClose="HandleAppSwitcherClose"
                                          OnAppSelected="HandleAppSwitcherSelect" />
    
    <!-- Lock Screen -->
    <OldiOSExperience.Pages.Springboard.Components.LockScreen IsLocked="@isLocked" OnUnlocked="HandleUnlocked" />
</div>

@code {
    // --- DATA from Services ---
    private List<List<AppInfo>> Pages => SpringboardService.Pages;
    private List<AppInfo> DockApps => SpringboardService.DockApps;
    private List<AppInfo> AllApps => SpringboardService.AllApps;
    private AppInfo? openedApp => AppManager.ForegroundApp?.App;
    private bool isAppOpen => openedApp != null;

    // --- STATE for SWIPING ---
    private int currentPageIndex = 0; // 0 = first app page, -1 = spotlight
    private double touchStartX = 0;
    private double touchCurrentX = 0;
    private double dragOffset = 0;
    private bool isDragging = false;
    
    // --- APP SWITCHER STATE ---
    private bool isAppSwitcherVisible = false;
    
    // --- LOCK SCREEN STATE ---
    private bool isLocked = true;
    private bool isUnlocking = false;
    
    // --- HOME BUTTON STATE ---
    private DateTime lastHomeButtonPress = DateTime.MinValue;
    private const int DoubleTapWindowMs = 400;
    
    // --- DEBUG ANIMATION STATE ---
    private bool debugAnimationActive = false;
    
    // We now have spotlight page, so total pages = spotlight + app pages
    // Position: -1 (spotlight), 0 (page 1), 1 (page 2), etc.
    private string filmstripStyle => $"transform: translateX(calc(-{currentPageIndex + 1} * 100% + {dragOffset}px)); transition: {(isDragging ? "none" : "transform 0.3s ease-out")};";

    protected override void OnInitialized()
    {
        // Initialize springboard layout via service
        SpringboardService.InitializeLayout();
        
        // Subscribe to app state changes
        AppManager.OnAppStatesChanged += HandleAppStateChanged;
    }
    
    private void ToggleDebugAnimation()
    {
        debugAnimationActive = !debugAnimationActive;
        StateHasChanged();
    }
    
    public void Dispose()
    {
        AppManager.OnAppStatesChanged -= HandleAppStateChanged;
    }
    
    private void HandleAppStateChanged()
    {
        StateHasChanged();
    }
    
    private async void HandleUnlocked()
    {
        // Start unlock animation - icons/dock fly in
        isUnlocking = true;
        StateHasChanged();
        
        // Wait for animation to complete
        await Task.Delay(400);
        
        // Finish unlock
        isLocked = false;
        isUnlocking = false;
        StateHasChanged();
    }
    
    private void HandleAppSwitcherClose()
    {
        isAppSwitcherVisible = false;
        StateHasChanged();
    }
    
    private void HandleAppSwitcherSelect(AppInfo app)
    {
        // Launch the selected app
        AppManager.LaunchApp(app);
        isAppSwitcherVisible = false;
        StateHasChanged();
    }
    
    // --- APP LAUNCHING ---
    private void HandleAppClick(AppInfo app)
    {
        SpringboardService.LaunchApp(app);
    }
    
    private void CloseApp()
    {
        AppManager.ReturnToSpringboard();
    }
    
    // Public method to handle home button press from parent
    public void HandleHomeButtonPress()
    {
        if (isLocked)
        {
            // If locked, home button wakes the screen but doesn't unlock
            return;
        }
        
        var now = DateTime.Now;
        var timeSinceLastPress = (now - lastHomeButtonPress).TotalMilliseconds;
        
        // Check for double-tap
        if (timeSinceLastPress <= DoubleTapWindowMs && AppManager.ForegroundApp == null)
        {
            // Double-tap detected on springboard - show app switcher
            isAppSwitcherVisible = true;
            lastHomeButtonPress = DateTime.MinValue; // Reset to prevent triple tap
        }
        else
        {
            // Single tap - normal home button behavior
            SpringboardService.HandleHomeButton();
            lastHomeButtonPress = now;
        }
        
        StateHasChanged();
        // In real iOS, if no app is open, home button does nothing on springboard
        // Could add "bounce" animation here in the future
    }

    // --- TOUCH EVENT HANDLERS ---
    private void HandleTouchStart(TouchEventArgs e)
    {
        isDragging = true;
        touchStartX = e.Touches[0].ClientX / DisplaySettings.SCALEFACTOR;
    }

    private void HandleTouchMove(TouchEventArgs e)
    {
        if (!isDragging) return;

        touchCurrentX = e.Touches[0].ClientX / DisplaySettings.SCALEFACTOR;
        dragOffset = touchCurrentX - touchStartX;
    }

    private void HandleTouchEnd(TouchEventArgs e)
    {
        if (!isDragging) return;
        isDragging = false;

        // Check if swipe was significant enough
        if (Math.Abs(dragOffset) > 50) // Swiped more than 50px
        {
            if (dragOffset < 0 && currentPageIndex < Pages.Count - 1)
            {
                // Swiped left, go to next page
                currentPageIndex++;
            }
            else if (dragOffset > 0 && currentPageIndex > -1)
            {
                // Swiped right, go to previous page (can go to spotlight at -1)
                currentPageIndex--;
            }
        }

        // Reset drag offset to snap back
        dragOffset = 0;
    }
    
    // --- MOUSE EVENT HANDLERS (for desktop testing) ---
    private bool isMouseDown = false;
    
    private void HandleMouseDown(MouseEventArgs e)
    {
        isMouseDown = true;
        isDragging = true;
        touchStartX = e.ClientX / DisplaySettings.SCALEFACTOR;
    }

    private void HandleMouseMove(MouseEventArgs e)
    {
        if (!isMouseDown || !isDragging) return;

        touchCurrentX = e.ClientX / DisplaySettings.SCALEFACTOR;
        dragOffset = touchCurrentX - touchStartX;
    }

    private void HandleMouseUp(MouseEventArgs e)
    {
        if (!isMouseDown) return;
        isMouseDown = false;
        isDragging = false;

        // Check if swipe was significant enough
        if (Math.Abs(dragOffset) > 50)
        {
            if (dragOffset < 0 && currentPageIndex < Pages.Count - 1)
            {
                currentPageIndex++;
            }
            else if (dragOffset > 0 && currentPageIndex > -1)
            {
                currentPageIndex--;
            }
        }

        dragOffset = 0;
    }
}