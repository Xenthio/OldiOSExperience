@using OldiOSExperience.Data
@using OldiOSExperience.Services
@inject AnimationService AnimationService

<div class="springboard-container @GetAnimationClass()">
    <!-- Wallpaper -->
    <img src="images/wallpaper.png" class="wallpaper @GetPageIndicatorAnimationClass()" alt="Wallpaper"/>

    <!-- Status Bar (using our rem units) -->
    <div class="status-bar @GetPageIndicatorAnimationClass()">
        <!-- Add status bar elements here later -->
    </div>

    <!-- Pages Container (the part that swipes) -->
    <div class="springboard-pages-container @GetPageIndicatorAnimationClass()"
         @ontouchstart="HandleTouchStart"
         @ontouchmove="HandleTouchMove"
         @ontouchend="HandleTouchEnd"
         @onmousedown="HandleMouseDown"
         @onmousemove="HandleMouseMove"
         @onmouseup="HandleMouseUp"
         @onmouseleave="HandleMouseUp">
        
        <div class="springboard-pages-filmstrip" style="@filmstripStyle">
            <!-- Spotlight Page (index -1) -->
            <div class="springboard-page spotlight-container">
                <OldiOSExperience.Pages.Springboard.Components.Spotlight AllApps="AllApps" />
            </div>
            
            <!-- Regular App Pages -->
            @foreach (var page in Pages)
            {
                <div class="springboard-page">
                    @foreach (var app in page)
                    {
                        <OldiOSExperience.Pages.Springboard.Components.AppIcon App="app" OnAppClick="HandleAppClick" />
                    }
                </div>
            }
        </div>
    </div>

    <!-- Page Indicator Dots -->
    <div class="page-indicator @GetPageIndicatorAnimationClass()">
        @for (int i = 0; i < Pages.Count; i++)
        {
            <div class="dot @(i == currentPageIndex ? "active" : "")"></div>
        }
    </div>

    <!-- The Dock -->
    <div class="dock @GetDockAnimationClass()">
        <div class="dock-background"></div>
        <div class="dock-icons">
            @foreach (var app in DockApps)
            {
                <OldiOSExperience.Pages.Springboard.Components.AppIcon App="app" OnAppClick="HandleAppClick" IsInDock="true" />
            }
        </div>
    </div>
    
    <!-- App Container for launching apps -->
    <OldiOSExperience.Pages.Springboard.Components.AppContainer CurrentApp="@openedApp" OnClose="CloseApp" />
</div>

@code {
    // --- DATA ---
    private List<List<AppInfo>> Pages { get; set; } = new();
    private List<AppInfo> DockApps { get; set; } = new();
    private List<AppInfo> AllApps { get; set; } = new();
    private AppInfo? openedApp = null;

    // --- STATE for SWIPING ---
    private int currentPageIndex = 0; // 0 = first app page, -1 = spotlight
    private double touchStartX = 0;
    private double touchCurrentX = 0;
    private double dragOffset = 0;
    private bool isDragging = false;
    
    // We now have spotlight page, so total pages = spotlight + app pages
    // Position: -1 (spotlight), 0 (page 1), 1 (page 2), etc.
    private string filmstripStyle => $"transform: translateX(calc(-{currentPageIndex + 1} * 100% + {dragOffset}px)); transition: {(isDragging ? "none" : "transform 0.3s ease-out")};";

    protected override void OnInitialized()
    {
        // --- POPULATE WITH MOCK DATA ---
        // This is where you would load your app list.

        DockApps = new List<AppInfo>
        {
            new AppInfo { Id = 101, Name = "Phone", IconPath = "images/icons/phone.png" },
            new AppInfo { Id = 102, Name = "Mail", IconPath = "images/icons/mail.png" },
            new AppInfo { Id = 103, Name = "Safari", IconPath = "images/icons/safari.png" },
            new AppInfo { Id = 104, Name = "Music", IconPath = "images/icons/music.png" }
        };

        var page1 = new List<AppInfo>
        {
            new AppInfo { Id = 1, Name = "Messages", IconPath = "images/icons/messages.png" },
            new AppInfo { Id = 2, Name = "Calendar", IconPath = "images/icons/calendar.png" },
            new AppInfo { Id = 3, Name = "Photos", IconPath = "images/icons/photos.png" },
            new AppInfo { Id = 4, Name = "Camera", IconPath = "images/icons/camera.png" },
            new AppInfo { Id = 5, Name = "YouTube", IconPath = "images/icons/youtube.png" },
            new AppInfo { Id = 6, Name = "Stocks", IconPath = "images/icons/stocks.png" },
            new AppInfo { Id = 7, Name = "Maps", IconPath = "images/icons/maps.png" },
            new AppInfo { Id = 8, Name = "Weather", IconPath = "images/icons/weather.png" }
        };

        var page2 = new List<AppInfo>
        {
            new AppInfo { Id = 9, Name = "Notes", IconPath = "images/icons/notes.png" },
            new AppInfo { Id = 10, Name = "Reminders", IconPath = "images/icons/reminders.png" },
            new AppInfo { Id = 11, Name = "Clock", IconPath = "images/icons/clock.png" },
            new AppInfo { Id = 12, Name = "Videos", IconPath = "images/icons/videos.png" },
            new AppInfo { Id = 13, Name = "App Store", IconPath = "images/icons/appstore.png" },
            new AppInfo { Id = 14, Name = "iTunes", IconPath = "images/icons/itunes.png" },
            new AppInfo { Id = 15, Name = "Game Center", IconPath = "images/icons/gamecenter.png" },
            new AppInfo { Id = 16, Name = "Settings", IconPath = "images/icons/settings.png" }
        };

        Pages.Add(page1);
        Pages.Add(page2);
        
        // Create a combined list of all apps for Spotlight search
        AllApps = DockApps.Concat(Pages.SelectMany(page => page)).ToList();
    }
    
    // --- APP LAUNCHING ---
    private async Task HandleAppClick(AppInfo app)
    {
        // The AppIcon component already called AnimationService.StartOpeningAnimation
        // with the correct center position
        
        // Wait a bit for the animation to start
        await Task.Delay(AnimationService.ANIMATION_START_DELAY_MS);
        openedApp = app;
        
        // Complete the animation after the app opens
        await Task.Delay(AnimationService.ANIMATION_DURATION_MS);
        AnimationService.CompleteAnimation();
    }
    
    private async Task CloseApp()
    {
        AnimationService.StartClosingAnimation();
        
        // Wait for animation to complete
        await Task.Delay(AnimationService.ANIMATION_DURATION_MS);
        openedApp = null;
        
        AnimationService.CompleteAnimation();
    }
    
    private string GetAnimationClass()
    {
        if (!AnimationService.IsAnimating) return "";
        
        return AnimationService.CurrentState switch
        {
            AnimationState.Opening => "opening-app",
            AnimationState.Closing => "closing-app",
            _ => ""
        };
    }
    
    private string GetDockAnimationClass()
    {
        if (!AnimationService.IsAnimating) return "";
        
        return AnimationService.CurrentState switch
        {
            AnimationState.Opening => "dock-lowering",
            AnimationState.Closing => "dock-rising",
            _ => ""
        };
    }
    
    private string GetPageIndicatorAnimationClass()
    {
        if (!AnimationService.IsAnimating) return "";
        
        return AnimationService.CurrentState switch
        {
            AnimationState.Opening => "fade-out-indicator",
            AnimationState.Closing => "fade-in-indicator",
            _ => ""
        };
    }
    
    // Public method to handle home button press from parent
    public async Task HandleHomeButtonPress()
    {
        if (openedApp != null)
        {
            await CloseApp();
            StateHasChanged(); // Force re-render
        }
        // In real iOS, if no app is open, home button does nothing on springboard
        // Could add "bounce" animation here in the future
    }

    // --- TOUCH EVENT HANDLERS ---
    private void HandleTouchStart(TouchEventArgs e)
    {
        isDragging = true;
        touchStartX = e.Touches[0].ClientX;
    }

    private void HandleTouchMove(TouchEventArgs e)
    {
        if (!isDragging) return;

        touchCurrentX = e.Touches[0].ClientX;
        dragOffset = touchCurrentX - touchStartX;
    }

    private void HandleTouchEnd(TouchEventArgs e)
    {
        if (!isDragging) return;
        isDragging = false;

        // Check if swipe was significant enough
        if (Math.Abs(dragOffset) > 50) // Swiped more than 50px
        {
            if (dragOffset < 0 && currentPageIndex < Pages.Count - 1)
            {
                // Swiped left, go to next page
                currentPageIndex++;
            }
            else if (dragOffset > 0 && currentPageIndex > -1)
            {
                // Swiped right, go to previous page (can go to spotlight at -1)
                currentPageIndex--;
            }
        }

        // Reset drag offset to snap back
        dragOffset = 0;
    }
    
    // --- MOUSE EVENT HANDLERS (for desktop testing) ---
    private bool isMouseDown = false;
    
    private void HandleMouseDown(MouseEventArgs e)
    {
        isMouseDown = true;
        isDragging = true;
        touchStartX = e.ClientX;
    }

    private void HandleMouseMove(MouseEventArgs e)
    {
        if (!isMouseDown || !isDragging) return;

        touchCurrentX = e.ClientX;
        dragOffset = touchCurrentX - touchStartX;
    }

    private void HandleMouseUp(MouseEventArgs e)
    {
        if (!isMouseDown) return;
        isMouseDown = false;
        isDragging = false;

        // Check if swipe was significant enough
        if (Math.Abs(dragOffset) > 50)
        {
            if (dragOffset < 0 && currentPageIndex < Pages.Count - 1)
            {
                currentPageIndex++;
            }
            else if (dragOffset > 0 && currentPageIndex > -1)
            {
                currentPageIndex--;
            }
        }

        dragOffset = 0;
    }
}