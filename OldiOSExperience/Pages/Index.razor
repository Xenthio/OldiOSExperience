@page "/"
@using OldiOSExperience.Services
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="simulation-wrapper" @ref="simulationWrapperElement">
    <div class="phone-container" style="--phone-scale: @DisplaySettings.SCALEFACTOR.ToString()">
        <div class="screen-viewport">
            <div class="screen-content">
                <OldiOSExperience.Pages.Springboard.Springboard @ref="springboard" />
            </div>
        </div>
        <div class="home-button" @onclick="HandleHomeButtonClick">
            <div class="home-button-square"></div>
        </div>
    </div>
</div>

@code {
    private ElementReference simulationWrapperElement;
    private OldiOSExperience.Pages.Springboard.Springboard? springboard;
    private DotNetObjectReference<Index>? objRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("addResizeListener", objRef);
            await CalculateAndApplyScaleFactor();
        }
    }

    [JSInvokable]
    public async Task OnBrowserResize()
    {
        await CalculateAndApplyScaleFactor();
    }

    private async Task CalculateAndApplyScaleFactor()
    {
        // Get the available height of the wrapper
        var viewportHeight = await JSRuntime.InvokeAsync<double>("getElementHeight", simulationWrapperElement);

        // Total height of the phone model (1136px screen + 25px gap + 100px button)
        const double phoneModelHeight = 1261.0;
        
        if (viewportHeight > 0)
        {
            // Calculate scale based on height, with some padding (95%)
            // SET THE STATIC PROPERTY
            DisplaySettings.SCALEFACTOR = (viewportHeight / phoneModelHeight) * 0.95;
            StateHasChanged();
        }
    }

    private void HandleHomeButtonClick()
    {
        springboard?.HandleHomeButtonPress();
    }

    public void Dispose()
    {
        if (objRef != null)
        {
            JSRuntime.InvokeVoidAsync("removeResizeListener", objRef);
            objRef.Dispose();
        }
    }
}