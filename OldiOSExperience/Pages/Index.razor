@page "/"
@using OldiOSExperience.Services
@inject IJSRuntime JSRuntime

<div class="phone-container">
    <!-- This is the responsive viewport. Its size is controlled by CSS. -->
    <div class="screen-viewport" @ref="screenViewportElement">

        <div class="screen-content">
            <OldiOSExperience.Pages.Springboard.Springboard @ref="springboard" />
        </div>

    </div>
    <div class="home-button" @onclick="HandleHomeButtonClick">
        <div class="home-button-square"></div>
    </div>
</div>

@code {
    private ElementReference screenViewportElement;
    // private double scaleFactor = 1.0; // This is no longer needed here.
    private string screenContentStyle => $"transform: scale({DisplaySettings.SCALEFACTOR.ToString(global::System.Globalization.CultureInfo.InvariantCulture)});";
    private OldiOSExperience.Pages.Springboard.Springboard? springboard;

    // This method is called after the component has rendered.
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // We only need to do this once when the page first loads.
        if (firstRender)
        {
            await CalculateAndApplyScaleFactor();
        }
    }


    private async Task CalculateAndApplyScaleFactor()
    {
        // Call our JS function to get the actual width of the viewport element
        var viewportWidth = await JSRuntime.InvokeAsync<double>("getElementWidth", screenViewportElement);

        if (viewportWidth > 0)
        {
            var prevScale = DisplaySettings.SCALEFACTOR;

            // Calculate the scale factor and set it on the static class
            DisplaySettings.SCALEFACTOR = viewportWidth / DisplaySettings.RESOLUTION_X;
            
            // Tell Blazor to re-render the component with the new style
            if (prevScale != DisplaySettings.SCALEFACTOR) StateHasChanged();
        }
    }
    
    private void HandleHomeButtonClick()
    {
        springboard?.HandleHomeButtonPress();
    }
}