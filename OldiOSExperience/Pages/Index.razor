@page "/"
@using OldiOSExperience.Services
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="simulation-wrapper" @ref="simulationWrapperElement">
    <div class="phone-container" style="--phone-scale: @DisplaySettings.SCALEFACTOR.ToString()">
        <div class="screen-viewport">
            <div class="screen-content">
                <OldiOSExperience.Pages.Springboard.Springboard @ref="springboard" />
            </div>
        </div>
        <div class="home-button" @onclick="HandleHomeButtonClick">
            <div class="home-button-square"></div>
        </div>
    </div>
</div>

@code {
    private ElementReference simulationWrapperElement;
    private OldiOSExperience.Pages.Springboard.Springboard? springboard;
    private DotNetObjectReference<Index>? objRef;

    // Helper record to receive dimensions from JS
    public record ElementDimensions(double Width, double Height);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("addResizeListener", objRef);
            await CalculateAndApplyScaleFactor();
        }
    }

    [JSInvokable]
    public async Task OnBrowserResize()
    {
        await CalculateAndApplyScaleFactor();
    }

    private async Task CalculateAndApplyScaleFactor()
    {
        var viewport = await JSRuntime.InvokeAsync<ElementDimensions>("getElementDimensions", simulationWrapperElement);

        if (viewport.Width > 0 && viewport.Height > 0)
        {
            // Define the native dimensions of the phone model
            const double phoneModelWidth = 640.0;
            // Height of screen (960) + gap (25) + home button (100)
            const double phoneModelHeight = 1085.0; 

            // Calculate scale factor based on width and height, leaving 5% padding
            var scaleX = (viewport.Width * 0.95) / phoneModelWidth;
            var scaleY = (viewport.Height * 0.95) / phoneModelHeight;

            // Use the smaller of the two scales to ensure it fits, and cap it at 1.0
            DisplaySettings.SCALEFACTOR = Math.Min(1.0, Math.Min(scaleX, scaleY));
            
            StateHasChanged();
        }
    }

    private void HandleHomeButtonClick()
    {
        springboard?.HandleHomeButtonPress();
    }

    public void Dispose()
    {
        if (objRef != null)
        {
            JSRuntime.InvokeVoidAsync("removeResizeListener", objRef);
            objRef.Dispose();
        }
    }
}