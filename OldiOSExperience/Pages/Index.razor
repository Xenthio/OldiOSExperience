@page "/"
@inject IJSRuntime JSRuntime
@using OldiOSExperience.Services
@inject BackgroundAppManager AppManager

<div class="phone-container">
    <!-- This is the responsive viewport. Its size is controlled by CSS. -->
    <div class="screen-viewport" @ref="screenViewportElement">

        <!-- This is the fixed-size content that gets scaled. -->
        <div class="screen-content" style="@screenContentStyle">
            <OldiOSExperience.Pages.Springboard.Springboard @ref="springboard" />
            <OldiOSExperience.System.AppSwitcher IsVisible="@isAppSwitcherVisible" 
                                                  OnClose="HandleAppSwitcherClose"
                                                  OnAppSelected="HandleAppSwitcherSelect" />
            <OldiOSExperience.System.LockScreen IsLocked="@isLocked" OnUnlocked="HandleUnlocked" />
        </div>

    </div>
    <div class="home-button" @onclick="HandleHomeButtonClick">
        <div class="home-button-square"></div>
    </div>
</div>

@code {
    private ElementReference screenViewportElement;
    private double scaleFactor = 1.0;
    private string screenContentStyle => $"transform: scale({scaleFactor.ToString(global::System.Globalization.CultureInfo.InvariantCulture)});";
    private OldiOSExperience.Pages.Springboard.Springboard? springboard;
    private bool isLocked = true;
    private bool isAppSwitcherVisible = false;
    
    // Double-tap detection
    private DateTime lastHomeButtonPress = DateTime.MinValue;
    private const int DoubleTapWindowMs = 400;

    // This method is called after the component has rendered.
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        // We only need to do this once when the page first loads.
        if (firstRender)
        {
            await CalculateAndApplyScaleFactor();
        }
    }

    private async Task CalculateAndApplyScaleFactor()
    {
        // Call our JS function to get the actual width of the viewport element
        var viewportWidth = await JSRuntime.InvokeAsync<double>("getElementWidth", screenViewportElement);

        if (viewportWidth > 0)
        {
            // Calculate the scale factor
            scaleFactor = viewportWidth / 640.0;
            
            // Tell Blazor to re-render the component with the new style
            StateHasChanged();
        }
    }
    
    private void HandleHomeButtonClick()
    {
        if (isLocked)
        {
            // If locked, home button wakes the screen but doesn't unlock
            return;
        }
        
        var now = DateTime.Now;
        var timeSinceLastPress = (now - lastHomeButtonPress).TotalMilliseconds;
        
        // Check for double-tap
        if (timeSinceLastPress <= DoubleTapWindowMs && AppManager.ForegroundApp == null)
        {
            // Double-tap detected on springboard - show app switcher
            isAppSwitcherVisible = true;
            lastHomeButtonPress = DateTime.MinValue; // Reset to prevent triple tap
        }
        else
        {
            // Single tap - normal home button behavior
            springboard?.HandleHomeButtonPress();
            lastHomeButtonPress = now;
        }
        
        StateHasChanged();
    }
    
    private void HandleUnlocked()
    {
        isLocked = false;
        StateHasChanged();
    }
    
    private void HandleAppSwitcherClose()
    {
        isAppSwitcherVisible = false;
        StateHasChanged();
    }
    
    private void HandleAppSwitcherSelect(Models.AppInfo app)
    {
        // Launch the selected app
        AppManager.LaunchApp(app);
        StateHasChanged();
    }
}