@page "/"
@using OldiOS.Shared.Services
@inject IJSRuntime JSRuntime
@inject DisplaySettings DisplaySettings
@inject IHapticService HapticService
@implements IDisposable

<div class="simulation-wrapper" @ref="simulationWrapperElement">
    <div class="phone-container" style="--phone-scale: @DisplaySettings.SCALEFACTOR.ToString(); width: @(DisplaySettings.RESOLUTION_X)px;">
        <div class="screen-viewport" style="width: @(DisplaySettings.RESOLUTION_X)px; height: @(DisplaySettings.RESOLUTION_Y)px;">
            <div class="screen-content">
                <OldiOS.Shared.Pages.Springboard.Springboard @ref="springboard" DebugAnimationActive="@debugAnimationActive" />
            </div>
        </div>
        <div class="home-button @(isHomeButtonPressed ? "pressed" : "")" 
             @ref="homeButtonElement"
             @onpointerdown="HandleHomeButtonPressIn"
             @onpointerup="HandleHomeButtonPressOut"
             @onpointercancel="HandleHomeButtonPressOut">
            <div class="home-button-square"></div>
            @if (pressureLevel > 0)
            {
                <div class="pressure-indicator" style="opacity: @(pressureLevel)"></div>
            }
        </div>
    </div>
</div>

<!-- Debug Menu - globally accessible -->
<OldiOS.Shared.System.DebugMenu @bind-ShowIcons="debugAnimationActive" />

@code {
    private ElementReference simulationWrapperElement;
    private ElementReference homeButtonElement;
    private OldiOS.Shared.Pages.Springboard.Springboard? springboard;
    private DotNetObjectReference<Index>? objRef;
    private bool debugAnimationActive = false;
    private bool isHomeButtonPressed = false;
    private double pressureLevel = 0;
    private bool is3DTouchActive = false;

    // Home button press timing for multi-tap detection
    private DateTime pressInTime = DateTime.MinValue;
    private int pressCount = 0;
    private Timer? actionTimer;
    private bool momentaryDisable = false;
    private const int MultiTapWindowMs = 300; // Time window for detecting multi-taps
    private const int LongPressThresholdMs = 500; // Time threshold for long press

    // Helper record to receive dimensions from JS
    public record ElementDimensions(double Width, double Height);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("addResizeListener", objRef);
            await JSRuntime.InvokeVoidAsync("initializeHomeButtonPressure", homeButtonElement, objRef);
            await CalculateAndApplyScaleFactor();

            // Subscribe to resolution changes
            DisplaySettings.OnResolutionChanged += HandleResolutionChanged;
        }
    }

    private async void HandleResolutionChanged()
    {
        await CalculateAndApplyScaleFactor();
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnBrowserResize()
    {
        await CalculateAndApplyScaleFactor();
    }

    [JSInvokable]
    public void OnHomeButtonPressure(double pressure)
    {
        var previousPressure = pressureLevel;
        pressureLevel = pressure;

        // Detect if this device supports variable pressure
        // Per Mozilla docs: Non-pressure devices (mouse, standard touch) report exactly 0 or 0.5
        //   - 0 when not pressed
        //   - 0.5 when pressed (active buttons state)
        // Pressure-sensitive devices report intermediate values (0.01-0.49, 0.51-1.0)
        // We detect pressure support by finding any value that is NOT exactly 0 or 0.5
        if (!hasDetectedPressureSupport && pressure != 0 && pressure != 0.5)
        {
            deviceSupportsPressure = true;
            hasDetectedPressureSupport = true;

            // Cancel any pending pointer event timers
            isWaitingForPressureDetection = false;
            pointerDelayTimer?.Dispose();
            pointerDelayTimer = null;
        }

        // On pressure-sensitive devices, only force press counts as activation
        if (deviceSupportsPressure)
        {
            // 3D Touch activation threshold (0.25 = 25% pressure, matching iOS behavior)
            if (pressure > 0.25 && !is3DTouchActive)
            {
                // 3D Touch "click down" - feels like the button clicked in
                is3DTouchActive = true;
                isHomeButtonPressed = true;
                pressInTime = DateTime.Now;

                // Trigger strong haptic feedback for 3D Touch activation (mechanical click feel)
                HapticService.ImpactHeavy();

                // Cancel any pending single-press action from a previous tap
                actionTimer?.Dispose();
                actionTimer = null;

                pressCount++;

                if (pressCount == 2)
                {
                    // This is a confirmed double-press, fire the action immediately
                    if (!momentaryDisable)
                    {
                        momentaryDisable = true;
                        PerformDoubleHomeAction();

                        // Reset momentary disable after short delay
                        _ = Task.Run(async () =>
                        {
                            await Task.Delay(500);
                            momentaryDisable = false;
                        });
                    }
                }

                StateHasChanged();
            }
            else if (pressure <= 0.15 && is3DTouchActive)
            {
                // 3D Touch "click up" - feels like the button released
                is3DTouchActive = false;
                isHomeButtonPressed = false;
                var pressDuration = (DateTime.Now - pressInTime).TotalMilliseconds;

                // Trigger medium haptic feedback for 3D Touch deactivation (mechanical release feel)
                HapticService.ImpactMedium();

                // Check if this was a long press
                if (pressDuration >= LongPressThresholdMs)
                {
                    HandleLongPress();
                    pressCount = 0;
                    StateHasChanged();
                    return;
                }

                if (pressCount == 1)
                {
                    // The user has lifted their finger after one press.
                    // Schedule the single-press action to happen after a short delay.
                    actionTimer = new Timer(_ =>
                    {
                        InvokeAsync(() =>
                        {
                            PerformHomeAction();
                            pressCount = 0;
                        });
                    }, null, MultiTapWindowMs, Timeout.Infinite);
                }
                else if (pressCount >= 2)
                {
                    // If it was a double-press or more, just reset the count immediately on release.
                    pressCount = 0;
                }

                StateHasChanged();
            }
            else if (pressure > 0)
            {
                // Just update the visual pressure indicator, no action
                StateHasChanged();
            }
        }
        else if (hasDetectedPressureSupport)
        {
            // Device confirmed to not support pressure, just update visual if any
            if (pressure > 0)
            {
                StateHasChanged();
            }
        }
    }

    private async Task CalculateAndApplyScaleFactor()
    {
        var viewport = await JSRuntime.InvokeAsync<ElementDimensions>("getElementDimensions", simulationWrapperElement);

        if (viewport.Width > 0 && viewport.Height > 0)
        {
            // Use resolution from DisplaySettings service
            var phoneModelWidth = DisplaySettings.RESOLUTION_X;
            // Height of screen + gap (25) + home button (100)
            var phoneModelHeight = DisplaySettings.RESOLUTION_Y + 125.0;

            // Calculate scale factor based on width and height, leaving 5% padding
            var scaleX = (viewport.Width * 0.95) / phoneModelWidth;
            var scaleY = (viewport.Height * 0.95) / phoneModelHeight;

            // Use the smaller of the two scales to ensure it fits, and cap it at 1.0
            var rawScale = Math.Min(1.0, Math.Min(scaleX, scaleY));

            // Predefined discrete scales we want to snap to when close
            var scaleCandidates = new double[] { 1.0, 0.9, 0.8, 0.75, 0.67, 0.5, 0.33, 0.25 };
            const double snapThreshold = 0.03; // 3% absolute threshold for snapping

            // Find the closest candidate
            double bestCandidate = rawScale;
            double bestDiff = double.MaxValue;
            foreach (var c in scaleCandidates)
            {
                var diff = Math.Abs(rawScale - c);
                if (diff < bestDiff)
                {
                    bestDiff = diff;
                    bestCandidate = c;
                }
            }

            var finalScale = (bestDiff <= snapThreshold) ? bestCandidate : Math.Round(rawScale, 2);

            // Assign final scale (already capped at 1.0 via rawScale)
            DisplaySettings.SCALEFACTOR = finalScale;

            StateHasChanged();
        }
    }


    private bool deviceSupportsPressure = false;
    private bool hasDetectedPressureSupport = false;
    private Timer? pointerDelayTimer;
    private bool isWaitingForPressureDetection = false;
    
    private void HandleHomeButtonPressIn(PointerEventArgs e)
    {
        // If we've detected pressure support, ignore pointer events in favor of pressure detection
        if (deviceSupportsPressure)
        {
            return;
        }
        
        // If 3D Touch is active, this is already handled by pressure detection
        if (is3DTouchActive)
        {
            return;
        }
        
        // Wait briefly on first touch to see if pressure varies (indicates pressure support)
        if (!hasDetectedPressureSupport)
        {
            isWaitingForPressureDetection = true;
            pointerDelayTimer?.Dispose();
            pointerDelayTimer = new Timer(_ =>
            {
                InvokeAsync(() =>
                {
                    // If we still haven't detected pressure support, assume device doesn't have it
                    if (!deviceSupportsPressure)
                    {
                        hasDetectedPressureSupport = true;
                        ExecutePointerPressIn();
                    }
                    isWaitingForPressureDetection = false;
                });
            }, null, 150, Timeout.Infinite); // 150ms delay to detect pressure
            return;
        }
        
        // Device confirmed to not support pressure, process immediately
        ExecutePointerPressIn();
    }
    
    private void ExecutePointerPressIn()
    {
        // If 3D Touch is active, this is already handled by pressure detection
        if (is3DTouchActive || deviceSupportsPressure)
        {
            return;
        }
        
        isHomeButtonPressed = true;
        pressInTime = DateTime.Now;
        
        // Heavy haptic feedback on press down
        HapticService.ImpactHeavy();
        
        // Cancel any pending single-press action from a previous tap
        actionTimer?.Dispose();
        actionTimer = null;
        
        pressCount++;
        
        if (pressCount == 2)
        {
            // This is a confirmed double-press, fire the action immediately
            if (!momentaryDisable)
            {
                momentaryDisable = true;
                PerformDoubleHomeAction();
                
                // Reset momentary disable after short delay
                _ = Task.Run(async () =>
                {
                    await Task.Delay(500);
                    momentaryDisable = false;
                });
            }
        }
        
        StateHasChanged();
    }
    
    private void HandleHomeButtonPressOut(PointerEventArgs e)
    {
        // If device supports pressure, ignore pointer events
        if (deviceSupportsPressure)
        {
            return;
        }
        
        // Cancel any pending pointer delay
        isWaitingForPressureDetection = false;
        pointerDelayTimer?.Dispose();
        pointerDelayTimer = null;
        
        // If 3D Touch was active, don't process regular pointer events
        // The pressure handler will manage the press-out
        if (is3DTouchActive)
        {
            return;
        }
        
        // If we're still waiting for pressure detection, don't process yet
        if (isWaitingForPressureDetection)
        {
            return;
        }
        
        isHomeButtonPressed = false;
        var pressDuration = (DateTime.Now - pressInTime).TotalMilliseconds;
        
        // Medium haptic feedback on release
        HapticService.ImpactMedium();
        
        // Check if this was a long press
        if (pressDuration >= LongPressThresholdMs)
        {
            HandleLongPress();
            pressCount = 0;
            StateHasChanged();
            return;
        }
        
        if (pressCount == 1)
        {
            // The user has lifted their finger after one press.
            // Schedule the single-press action to happen after a short delay.
            actionTimer = new Timer(_ =>
            {
                InvokeAsync(() =>
                {
                    PerformHomeAction();
                    pressCount = 0;
                });
            }, null, MultiTapWindowMs, Timeout.Infinite);
        }
        else if (pressCount >= 2)
        {
            // If it was a double-press or more, just reset the count immediately on release.
            pressCount = 0;
        }
        
        StateHasChanged();
    }
    
    private void PerformHomeAction()
    {
        // Single tap - normal home button behavior
        springboard?.HandleHomeButtonSinglePress();
    }
    
    private void PerformDoubleHomeAction()
    {
        // Double-tap - show app switcher
        springboard?.HandleHomeButtonDoublePress();
        pressCount = 0;
    }
    
    private void HandleLongPress()
    {
        // Long press - could activate Siri or voice control in the future
        springboard?.HandleHomeButtonLongPress();
    }

    public void Dispose()
    {
        if (objRef != null)
        {
            JSRuntime.InvokeVoidAsync("removeResizeListener", objRef);
            JSRuntime.InvokeVoidAsync("cleanupHomeButtonPressure");
            objRef.Dispose();
        }
        
        actionTimer?.Dispose();
        DisplaySettings.OnResolutionChanged -= HandleResolutionChanged;
    }
}