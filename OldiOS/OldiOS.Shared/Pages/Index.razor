@page "/"
@using OldiOS.Shared.Services
@inject IJSRuntime JSRuntime
@inject DisplaySettings DisplaySettings
@inject IHapticService HapticService
@implements IDisposable

<div class="simulation-wrapper" @ref="simulationWrapperElement">
    <div class="phone-container" style="--phone-scale: @DisplaySettings.SCALEFACTOR.ToString(); width: @(DisplaySettings.RESOLUTION_X)px;">
        <div class="screen-viewport" style="width: @(DisplaySettings.RESOLUTION_X)px; height: @(DisplaySettings.RESOLUTION_Y)px;">
            <div class="screen-content">
                <OldiOS.Shared.Pages.Springboard.Springboard @ref="springboard" DebugAnimationActive="@debugAnimationActive" />
            </div>
        </div>
        <div class="home-button @(isHomeButtonPressed ? "pressed" : "")" 
             @ref="homeButtonElement"
             @onpointerdown="HandleHomeButtonPressIn"
             @onpointerup="HandleHomeButtonPressOut"
             @onpointercancel="HandleHomeButtonPressOut">
            <div class="home-button-square"></div>
            @if (pressureLevel > 0)
            {
                <div class="pressure-indicator" style="opacity: @(pressureLevel)"></div>
            }
        </div>
    </div>
</div>

<!-- Debug Menu - globally accessible -->
<OldiOS.Shared.System.DebugMenu @bind-ShowIcons="debugAnimationActive" />

@code {
    private ElementReference simulationWrapperElement;
    private ElementReference homeButtonElement;
    private OldiOS.Shared.Pages.Springboard.Springboard? springboard;
    private DotNetObjectReference<Index>? objRef;
    private bool debugAnimationActive = false;
    private bool isHomeButtonPressed = false;
    private double pressureLevel = 0;
    private bool is3DTouchActive = false;
    
    // Home button press timing for multi-tap detection
    private DateTime pressInTime = DateTime.MinValue;
    private int pressCount = 0;
    private Timer? actionTimer;
    private bool momentaryDisable = false;
    private const int MultiTapWindowMs = 300; // Time window for detecting multi-taps
    private const int LongPressThresholdMs = 500; // Time threshold for long press

    // Helper record to receive dimensions from JS
    public record ElementDimensions(double Width, double Height);

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("addResizeListener", objRef);
            await JSRuntime.InvokeVoidAsync("initializeHomeButtonPressure", homeButtonElement, objRef);
            await CalculateAndApplyScaleFactor();
            
            // Subscribe to resolution changes
            DisplaySettings.OnResolutionChanged += HandleResolutionChanged;
        }
    }

    private async void HandleResolutionChanged()
    {
        await CalculateAndApplyScaleFactor();
        StateHasChanged();
    }

    [JSInvokable]
    public async Task OnBrowserResize()
    {
        await CalculateAndApplyScaleFactor();
    }

    [JSInvokable]
    public void OnHomeButtonPressure(double pressure)
    {
        pressureLevel = pressure;
        
        // 3D Touch activation threshold (0.5 = 50% pressure)
        if (pressure > 0.5 && !is3DTouchActive)
        {
            is3DTouchActive = true;
            isHomeButtonPressed = true;
            
            // Trigger haptic feedback for 3D Touch activation
            HapticService.ImpactHeavy();
            
            StateHasChanged();
        }
        else if (pressure <= 0.3 && is3DTouchActive)
        {
            is3DTouchActive = false;
            isHomeButtonPressed = false;
            StateHasChanged();
        }
        else if (pressure > 0.1 && pressure <= 0.5 && !is3DTouchActive)
        {
            // Light haptic for normal press
            if (pressure > 0.1 && pressureLevel <= 0.1)
            {
                HapticService.ImpactLight();
            }
            StateHasChanged();
        }
    }

    private async Task CalculateAndApplyScaleFactor()
    {
        var viewport = await JSRuntime.InvokeAsync<ElementDimensions>("getElementDimensions", simulationWrapperElement);

        if (viewport.Width > 0 && viewport.Height > 0)
        {
            // Use resolution from DisplaySettings service
            var phoneModelWidth = DisplaySettings.RESOLUTION_X;
            // Height of screen + gap (25) + home button (100)
            var phoneModelHeight = DisplaySettings.RESOLUTION_Y + 125.0; 

            // Calculate scale factor based on width and height, leaving 5% padding
            var scaleX = (viewport.Width * 0.95) / phoneModelWidth;
            var scaleY = (viewport.Height * 0.95) / phoneModelHeight;

            // Use the smaller of the two scales to ensure it fits, and cap it at 1.0
            DisplaySettings.SCALEFACTOR = Math.Min(1.0, Math.Min(scaleX, scaleY));
            
            StateHasChanged();
        }
    }

    private void HandleHomeButtonPressIn(PointerEventArgs e)
    {
        isHomeButtonPressed = true;
        pressInTime = DateTime.Now;
        
        // Heavy haptic feedback on press down
        HapticService.ImpactHeavy();
        
        // Cancel any pending single-press action from a previous tap
        actionTimer?.Dispose();
        actionTimer = null;
        
        pressCount++;
        
        if (pressCount == 2)
        {
            // This is a confirmed double-press, fire the action immediately
            if (!momentaryDisable)
            {
                momentaryDisable = true;
                PerformDoubleHomeAction();
                
                // Reset momentary disable after short delay
                _ = Task.Run(async () =>
                {
                    await Task.Delay(500);
                    momentaryDisable = false;
                });
            }
        }
        
        StateHasChanged();
    }
    
    private void HandleHomeButtonPressOut(PointerEventArgs e)
    {
        isHomeButtonPressed = false;
        var pressDuration = (DateTime.Now - pressInTime).TotalMilliseconds;
        
        // Medium haptic feedback on release
        HapticService.ImpactMedium();
        
        // Check if this was a long press
        if (pressDuration >= LongPressThresholdMs)
        {
            HandleLongPress();
            pressCount = 0;
            StateHasChanged();
            return;
        }
        
        if (pressCount == 1)
        {
            // The user has lifted their finger after one press.
            // Schedule the single-press action to happen after a short delay.
            actionTimer = new Timer(_ =>
            {
                InvokeAsync(() =>
                {
                    PerformHomeAction();
                    pressCount = 0;
                });
            }, null, MultiTapWindowMs, Timeout.Infinite);
        }
        else if (pressCount >= 2)
        {
            // If it was a double-press or more, just reset the count immediately on release.
            pressCount = 0;
        }
        
        StateHasChanged();
    }
    
    private void PerformHomeAction()
    {
        // Single tap - normal home button behavior
        springboard?.HandleHomeButtonSinglePress();
    }
    
    private void PerformDoubleHomeAction()
    {
        // Double-tap - show app switcher
        springboard?.HandleHomeButtonDoublePress();
        pressCount = 0;
    }
    
    private void HandleLongPress()
    {
        // Long press - could activate Siri or voice control in the future
        springboard?.HandleHomeButtonLongPress();
    }

    public void Dispose()
    {
        if (objRef != null)
        {
            JSRuntime.InvokeVoidAsync("removeResizeListener", objRef);
            JSRuntime.InvokeVoidAsync("cleanupHomeButtonPressure");
            objRef.Dispose();
        }
        
        actionTimer?.Dispose();
        DisplaySettings.OnResolutionChanged -= HandleResolutionChanged;
    }
}