@* iOS 5 Safari Browser - Works on both Web and MAUI *@
@using OldiOS.Shared.Apps.UIKit
@using Microsoft.JSInterop
@using OldiOS.Services
@inject IJSRuntime JSRuntime
@inject ISafariWebViewService SafariWebViewService
@implements IAsyncDisposable

<div class="safari-app">
    <div class="safari-header">
        <div class="address-bar">
            <div class="search-field">
                <input type="text" 
                       class="url-input" 
                       placeholder="Search or enter website name"
                       @bind="urlInput"
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown" />
            </div>
            <button class="refresh-button" @onclick="Reload">‚Üª</button>
        </div>
    </div>
    
    <div class="safari-content">
        @if (showPlaceholder)
        {
            <div class="browser-view">
                <div class="placeholder-page">
                    <div class="placeholder-icon">üåê</div>
                    <div class="placeholder-text">Safari</div>
                    <div class="placeholder-hint">Enter a URL or search term to browse the web</div>
                    <div class="example-sites">
                        <div class="example-title">Iframe-friendly sites to try:</div>
                        <button class="example-site" @onclick='() => LoadUrl("en.wikipedia.org")'>Wikipedia</button>
                        <button class="example-site" @onclick='() => LoadUrl("archive.org")'>Internet Archive</button>
                        <button class="example-site" @onclick='() => LoadUrl("info.cern.ch")'>CERN (First Website)</button>
                        <button class="example-site" @onclick='() => LoadUrl("theuselessweb.com")'>The Useless Web</button>
                    </div>
                    @if (IsMauiPlatform)
                    {
                        <div class="platform-info maui-info">
                            ‚úÖ MAUI Native - Full website compatibility with iPhone 4 user agent
                        </div>
                    }
                    else
                    {
                        <div class="platform-info web-info">
                            ‚ö†Ô∏è Web Browser - Many modern websites prevent loading in embedded frames for security.
                            Sites may redirect or show error messages.
                        </div>
                    }
                </div>
            </div>
        }
        else if (showError)
        {
            <div class="browser-view">
                <div class="error-page">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">Cannot Open Page</div>
                    <div class="error-message">@errorMessage</div>
                    <div class="error-details">
                        @if (IsMauiPlatform)
                        {
                            <text>An error occurred while loading this website.</text>
                        }
                        else
                        {
                            <text>This website cannot be displayed in Safari due to security restrictions.
                            Many sites use X-Frame-Options headers to prevent loading in embedded frames.</text>
                        }
                    </div>
                    <button class="try-anyway-button" @onclick="() => showError = false">Try Anyway</button>
                    <button class="go-back-button" @onclick="ShowPlaceholder">Go Back</button>
                </div>
            </div>
        }
        else
        {
            <div class="browser-view">
                @if (isLoading)
                {
                    <div class="loading-overlay">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading...</div>
                    </div>
                }
                
                @if (IsMauiPlatform)
                {
                    @* MAUI: Native WebView is overlaid by MainPage, just show transparent area *@
                    <div class="native-webview-placeholder" style="width: 100%; height: 100%;"></div>
                }
                else
                {
                    @* Web: Use iframe *@
                    <iframe id="safari-iframe" 
                            src="@currentUrl" 
                            class="safari-iframe"
                            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"></iframe>
                }
            </div>
        }
    </div>
    
    <UIToolbar>
        <button class="toolbar-button" @onclick="NavigateBack" disabled="@(!canGoBack)">‚óÑ</button>
        <button class="toolbar-button" @onclick="NavigateForward" disabled="@(!canGoForward)">‚ñ∫</button>
        <button class="toolbar-button" @onclick="ShowBookmarks">üìë</button>
        <button class="toolbar-button" @onclick="ShowReadingList">üìñ</button>
        <button class="toolbar-button" @onclick="ShowMore">‚ãØ</button>
    </UIToolbar>
</div>

@code {
    private string urlInput = "";
    private string currentUrl = "";
    private bool showPlaceholder = true;
    private bool showError = false;
    private bool isLoading = false;
    private string errorMessage = "";
    private bool canGoBack = false;
    private bool canGoForward = false;
    private DotNetObjectReference<SafariApp>? dotNetReference;
    
#if ANDROID || IOS || MACCATALYST || WINDOWS
    private bool IsMauiPlatform => true;
#else
    private bool IsMauiPlatform => false;
#endif
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Setup iframe interop for all platforms (web and MAUI)
            dotNetReference = DotNetObjectReference.Create(this);
            try
            {
                await JSRuntime.InvokeVoidAsync("safariInterop.setupIframeErrorHandling", "safari-iframe", dotNetReference);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Safari JS setup error: {ex.Message}");
            }
        }
    }
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadUrl(urlInput);
        }
    }
    
    private async Task LoadUrl(string url)
    {
        if (string.IsNullOrWhiteSpace(url))
            return;
            
        urlInput = url;
        showError = false;
        showPlaceholder = false;
        isLoading = true;
        
        StateHasChanged();
        await Task.Delay(100); // Give Blazor time to render
        
        try
        {
#if ANDROID || IOS || MACCATALYST || WINDOWS
            if (IsMauiPlatform)
            {
                // MAUI: Use service to control native WebView
                SafariWebViewService.NavigateToUrl(url);
                
                // Clear loading state after a delay (native will handle the actual loading)
                _ = Task.Run(async () =>
                {
                    await Task.Delay(2000);
                    isLoading = false;
                    await InvokeAsync(StateHasChanged);
                });
            }
            else
#endif
            {
                // Web: Use iframe with compatibility check
                var compatibility = await JSRuntime.InvokeAsync<object>("safariInterop.isLikelyIframeFriendly", url);
                var suggestion = await JSRuntime.InvokeAsync<string>("safariInterop.suggestAlternative", url);
                
                if (!string.IsNullOrEmpty(suggestion))
                {
                    Console.WriteLine($"Safari compatibility warning: {suggestion}");
                }
                
                var normalizedUrl = await JSRuntime.InvokeAsync<string>("safariInterop.loadUrlInIframe", "safari-iframe", url);
                if (!string.IsNullOrEmpty(normalizedUrl))
                {
                    currentUrl = normalizedUrl;
                    urlInput = normalizedUrl;
                }
                else
                {
                    // Normalize URL directly
                    if (!url.StartsWith("http://") && !url.StartsWith("https://"))
                    {
                        if (url.Contains(".") && !url.Contains(" "))
                        {
                            currentUrl = "https://" + url;
                        }
                        else
                        {
                            currentUrl = "https://www.google.com/search?q=" + Uri.EscapeDataString(url);
                        }
                    }
                    else
                    {
                        currentUrl = url;
                    }
                    urlInput = currentUrl;
                }
                
                // Set a timeout to clear the loading state if iframe doesn't load
                _ = Task.Run(async () =>
                {
                    await Task.Delay(5000);
                    if (isLoading)
                    {
                        isLoading = false;
                        await InvokeAsync(StateHasChanged);
                    }
                });
            }
        }
        catch (Exception ex)
        {
            showError = true;
            errorMessage = ex.Message;
            isLoading = false;
        }
        
        StateHasChanged();
    }
    
    [JSInvokable]
    public void OnIframeLoaded(string url)
    {
        isLoading = false;
        currentUrl = url;
        urlInput = url;
        StateHasChanged();
    }
    
    [JSInvokable]
    public void OnIframeError(string error)
    {
        isLoading = false;
        showError = true;
        errorMessage = error;
        StateHasChanged();
    }
    
    private async Task NavigateBack()
    {
        try
        {
#if ANDROID || IOS || MACCATALYST || WINDOWS
            if (IsMauiPlatform)
            {
                SafariWebViewService.GoBack();
            }
            else
#endif
            {
                await JSRuntime.InvokeVoidAsync("safariInterop.navigateBack", "safari-iframe");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Navigate back error: {ex.Message}");
        }
    }
    
    private async Task NavigateForward()
    {
        try
        {
#if ANDROID || IOS || MACCATALYST || WINDOWS
            if (IsMauiPlatform)
            {
                SafariWebViewService.GoForward();
            }
            else
#endif
            {
                await JSRuntime.InvokeVoidAsync("safariInterop.navigateForward", "safari-iframe");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Navigate forward error: {ex.Message}");
        }
    }
    
    private async Task Reload()
    {
        if (showPlaceholder)
            return;
            
        isLoading = true;
        
        try
        {
#if ANDROID || IOS || MACCATALYST || WINDOWS
            if (IsMauiPlatform)
            {
                SafariWebViewService.Reload();
            }
            else
#endif
            {
                await JSRuntime.InvokeVoidAsync("safariInterop.reload", "safari-iframe");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Reload error: {ex.Message}");
            isLoading = false;
        }
        StateHasChanged();
    }
    
    private void ShowPlaceholder()
    {
        showPlaceholder = true;
        showError = false;
        currentUrl = "";
        urlInput = "";
    }
    
    private void ShowBookmarks()
    {
        // TODO: Implement bookmarks view
        Console.WriteLine("Bookmarks clicked");
    }
    
    private void ShowReadingList()
    {
        // TODO: Implement reading list
        Console.WriteLine("Reading list clicked");
    }
    
    private void ShowMore()
    {
        // TODO: Implement more options menu
        Console.WriteLine("More options clicked");
    }
    
    public async ValueTask DisposeAsync()
    {
        dotNetReference?.Dispose();
        await Task.CompletedTask;
    }
}
