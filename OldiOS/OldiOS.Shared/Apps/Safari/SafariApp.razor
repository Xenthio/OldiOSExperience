@* iOS 5 Safari Browser *@
@using OldiOS.Shared.Apps.UIKit

<div class="safari-app">
    <div
        class="safari-header @(IsTabSwitcherMode ? "hidden" : "") @(IsAnimatingEnter ? "animate-enter" : "") @(IsAnimatingExit ? "animate-exit" : "")">
        <div class="address-bar">
            <div class="search-field">
                <input type="text" class="url-input" placeholder="Search or enter website name" @bind="CurrentTab.Url"
                    @bind:event="oninput" @onkeydown="HandleKeyDown" />
            </div>
            <button class="refresh-button">â†»</button>
        </div>
    </div>

    <div @ref="tabSwitcherRef"
        class="tab-switcher @(IsTabSwitcherMode ? "visible" : "") @(IsAnimatingEnter ? "animate-enter" : "") @(IsAnimatingExit ? "animate-exit" : "")">
        <div class="tab-list">
            @foreach (var tab in Tabs)
            {
                <div class="tab-item @(tab == CurrentTab ? "active" : "")" @onclick="() => SwitchToTab(tab)">
                    <div class="tab-header">
                        <span class="tab-title">@(string.IsNullOrEmpty(tab.Title) ? "New Page" : tab.Title)</span>
                        <button class="close-tab-button" @onclick="() => CloseTab(tab)"
                        @onclick:stopPropagation="true">Ã—</button>
                    </div>
                    <div class="tab-snapshot">
                        @if (!string.IsNullOrEmpty(tab.SnapshotData))
                        {
                            <img src="@tab.SnapshotData" />
                        }
                        else
                        {
                            <div class="tab-placeholder"></div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <div class="safari-content">
        <div class="browser-view @(IsTabSwitcherMode ? "hidden" : "")">
            <UIWebView @ref="webView" Url="@CurrentTab.Url" OnUrlChanged="HandleUrlChanged"
                Style="width: 100%; height: 100%;" />
        </div>
    </div>

    <div class="safari-toolbar-container">
        <UIToolbar>
            @if (IsTabSwitcherMode)
            {
                <button class="toolbar-button" @onclick="AddNewTab">âž•</button>
                <div class="toolbar-spacer"></div>
                <button class="toolbar-button" @onclick="() => IsTabSwitcherMode = false">Done</button>
            }
            else
            {
                <button class="toolbar-button" @onclick="GoBack">â—„</button>
                <button class="toolbar-button" @onclick="GoForward">â–º</button>
                <button class="toolbar-button" @onclick="ShowTabs">ðŸ“‘</button>
                <button class="toolbar-button">ðŸ“–</button>
                <button class="toolbar-button">â‹¯</button>
            }
        </UIToolbar>
    </div>
</div>

@code {
    private bool IsTabSwitcherMode = false;
    private bool IsAnimatingEnter = false;
    private bool IsAnimatingExit = false;
    private global::System.Collections.Generic.List<SafariTab> Tabs = new
    global::System.Collections.Generic.List<SafariTab>();
    private SafariTab CurrentTab;
    private UIWebView webView;
    private ElementReference tabSwitcherRef;
    private global::System.Collections.Generic.Dictionary<SafariTab, ElementReference> tabRefs = new();

    [Inject] private IJSRuntime JSRuntime { get; set; }

    protected override void OnInitialized()
    {
        // Initialize with one tab
        AddNewTab();
    }

    private void HandleUrlChanged(string newUrl)
    {
        CurrentTab.Url = newUrl;
        // Ideally we'd fetch the title too
        CurrentTab.Title = newUrl;
        StateHasChanged();
    }

    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            Navigate();
        }
    }

    private void Navigate()
    {
        if (!string.IsNullOrWhiteSpace(CurrentTab.Url))
        {
            if (!CurrentTab.Url.StartsWith("http://") && !CurrentTab.Url.StartsWith("https://"))
            {
                CurrentTab.Url = "https://" + CurrentTab.Url;
            }
            webView?.Navigate(CurrentTab.Url);
        }
    }

    private void GoBack()
    {
        webView?.GoBack();
    }

    private void GoForward()
    {
        webView?.GoForward();
    }

    private async global::System.Threading.Tasks.Task ShowTabs()
    {
        // Capture snapshot of current tab
        if (webView != null)
        {
            CurrentTab.SnapshotData = await webView.GetSnapshotAsync();
        }

        IsTabSwitcherMode = true;
        IsAnimatingEnter = true;
        StateHasChanged();

        // Center the current tab using index
        var index = Tabs.IndexOf(CurrentTab);
        if (index >= 0)
        {
            await JSRuntime.InvokeVoidAsync("scrollToTab", tabSwitcherRef, index);
        }

        await global::System.Threading.Tasks.Task.Delay(300); // Match CSS animation duration
        IsAnimatingEnter = false;
        StateHasChanged();
    }

    private async global::System.Threading.Tasks.Task SwitchToTab(SafariTab tab)
    {
        IsAnimatingExit = true;
        StateHasChanged();

        await global::System.Threading.Tasks.Task.Delay(300); // Match CSS animation duration
        IsAnimatingExit = false;

        CurrentTab = tab;
        IsTabSwitcherMode = false;
        StateHasChanged();

        // Force WebView to update position since it was hidden
        await global::System.Threading.Tasks.Task.Delay(50); // Small delay to ensure DOM update
        if (webView != null)
        {
            await webView.Refresh();
        }
    }

    private void AddNewTab()
    {
        var newTab = new SafariTab { Url = "https://www.google.com", Title = "New Page" };
        Tabs.Add(newTab);
        CurrentTab = newTab;
        IsTabSwitcherMode = false;
        StateHasChanged();

        // Force refresh for new tab too if needed
        _ = global::System.Threading.Tasks.Task.Delay(50).ContinueWith(async _ =>
        {
            if (webView != null) await InvokeAsync(webView.Refresh);
        });
    }

    private void CloseTab(SafariTab tab)
    {
        Tabs.Remove(tab);
        if (Tabs.Count == 0)
        {
            AddNewTab();
        }
        else if (CurrentTab == tab)
        {
            CurrentTab = Tabs.Last();
        }
    }

    public class SafariTab
    {
        public string Url { get; set; } = "";
        public string Title { get; set; } = "";
        public string SnapshotData { get; set; } = "";
    }
}
