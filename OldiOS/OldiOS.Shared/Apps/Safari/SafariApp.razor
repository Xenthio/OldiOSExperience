@* iOS 5 Safari Browser - Works on both Web and MAUI *@
@using OldiOS.Shared.Apps.UIKit
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<div class="safari-app">
    <div class="safari-header">
        <div class="address-bar">
            <div class="search-field">
                <input type="text" 
                       class="url-input" 
                       placeholder="Search or enter website name"
                       @bind="urlInput"
                       @bind:event="oninput"
                       @onkeydown="HandleKeyDown" />
            </div>
            <button class="refresh-button" @onclick="Reload">‚Üª</button>
        </div>
    </div>
    
    <div class="safari-content">
        @if (showPlaceholder)
        {
            <div class="browser-view">
                <div class="placeholder-page">
                    <div class="placeholder-icon">üåê</div>
                    <div class="placeholder-text">Safari</div>
                    <div class="placeholder-hint">Enter a URL or search term to browse the web</div>
                    <div class="example-sites">
                        <div class="example-title">Try visiting:</div>
                        <button class="example-site" @onclick='() => LoadUrl("example.com")'>example.com</button>
                        <button class="example-site" @onclick='() => LoadUrl("wikipedia.org")'>wikipedia.org</button>
                        <button class="example-site" @onclick='() => LoadUrl("archive.org")'>archive.org</button>
                    </div>
                    @if (IsMauiPlatform)
                    {
                        <div class="platform-info maui-info">
                            ‚úÖ MAUI Native - Full website compatibility with iPhone 4 user agent
                        </div>
                    }
                    else
                    {
                        <div class="platform-info web-info">
                            ‚ö†Ô∏è Web Browser - Many modern websites prevent loading in embedded frames for security.
                            Sites may redirect or show error messages.
                        </div>
                    }
                </div>
            </div>
        }
        else if (showError)
        {
            <div class="browser-view">
                <div class="error-page">
                    <div class="error-icon">‚ö†Ô∏è</div>
                    <div class="error-title">Cannot Open Page</div>
                    <div class="error-message">@errorMessage</div>
                    <div class="error-details">
                        @if (IsMauiPlatform)
                        {
                            <text>An error occurred while loading this website.</text>
                        }
                        else
                        {
                            <text>This website cannot be displayed in Safari due to security restrictions.
                            Many sites use X-Frame-Options headers to prevent loading in embedded frames.</text>
                        }
                    </div>
                    <button class="try-anyway-button" @onclick="() => showError = false">Try Anyway</button>
                    <button class="go-back-button" @onclick="ShowPlaceholder">Go Back</button>
                </div>
            </div>
        }
        else
        {
            <div class="browser-view">
                @if (isLoading)
                {
                    <div class="loading-overlay">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">Loading...</div>
                    </div>
                }
                
                @if (IsMauiPlatform)
                {
                    <div class="webview-container" id="safari-webview-container"></div>
                }
                else
                {
                    <iframe id="safari-iframe" 
                            src="@currentUrl" 
                            class="safari-iframe"
                            sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-popups-to-escape-sandbox"></iframe>
                }
            </div>
        }
    </div>
    
    <UIToolbar>
        <button class="toolbar-button" @onclick="NavigateBack" disabled="@(!canGoBack)">‚óÑ</button>
        <button class="toolbar-button" @onclick="NavigateForward" disabled="@(!canGoForward)">‚ñ∫</button>
        <button class="toolbar-button" @onclick="ShowBookmarks">üìë</button>
        <button class="toolbar-button" @onclick="ShowReadingList">üìñ</button>
        <button class="toolbar-button" @onclick="ShowMore">‚ãØ</button>
    </UIToolbar>
</div>

@code {
    private string urlInput = "";
    private string currentUrl = "";
    private bool showPlaceholder = true;
    private bool showError = false;
    private bool isLoading = false;
    private string errorMessage = "";
    private bool canGoBack = false;
    private bool canGoForward = false;
    private DotNetObjectReference<SafariApp>? dotNetReference;
    
#if ANDROID || IOS || MACCATALYST || WINDOWS
    private OldiOS.Shared.Services.ISafariService? safariService;
    private bool IsMauiPlatform => true;
#else
    private bool IsMauiPlatform => false;
#endif
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
#if ANDROID || IOS || MACCATALYST || WINDOWS
            // MAUI platform - initialize native WebView
            await InitializeMauiWebView();
#else
            // Web platform - setup iframe interop
            dotNetReference = DotNetObjectReference.Create(this);
            try
            {
                await JSRuntime.InvokeVoidAsync("safariInterop.setupIframeErrorHandling", "safari-iframe", dotNetReference);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Safari JS setup error: {ex.Message}");
            }
#endif
        }
    }
    
#if ANDROID || IOS || MACCATALYST || WINDOWS
    private async Task InitializeMauiWebView()
    {
        try
        {
            // Get the platform-specific Safari service
            // This will be injected via dependency injection
            safariService = App.Current?.Handler?.MauiContext?.Services.GetService<OldiOS.Shared.Services.ISafariService>();
            
            if (safariService != null)
            {
                safariService.NavigationCompleted += OnMauiNavigationCompleted;
                safariService.NavigationFailed += OnMauiNavigationFailed;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"MAUI WebView initialization error: {ex.Message}");
        }
        
        await Task.CompletedTask;
    }
    
    private void OnMauiNavigationCompleted(object? sender, string url)
    {
        isLoading = false;
        currentUrl = url;
        urlInput = url;
        canGoBack = safariService?.CanGoBack ?? false;
        canGoForward = safariService?.CanGoForward ?? false;
        StateHasChanged();
    }
    
    private void OnMauiNavigationFailed(object? sender, string error)
    {
        isLoading = false;
        showError = true;
        errorMessage = error;
        StateHasChanged();
    }
#endif
    
    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await LoadUrl(urlInput);
        }
    }
    
    private async Task LoadUrl(string url)
    {
        if (string.IsNullOrWhiteSpace(url))
            return;
            
        urlInput = url;
        showError = false;
        showPlaceholder = false;
        isLoading = true;
        
#if ANDROID || IOS || MACCATALYST || WINDOWS
        // MAUI platform - use native WebView
        if (safariService != null)
        {
            var success = await safariService.LoadUrl(url);
            if (!success)
            {
                isLoading = false;
                showError = true;
                errorMessage = "Failed to load URL";
            }
        }
        StateHasChanged();
#else
        // Web platform - use iframe
        StateHasChanged();
        await Task.Delay(100); // Give Blazor time to render the iframe
        
        try
        {
            var normalizedUrl = await JSRuntime.InvokeAsync<string>("safariInterop.loadUrlInIframe", "safari-iframe", url);
            if (!string.IsNullOrEmpty(normalizedUrl))
            {
                currentUrl = normalizedUrl;
                urlInput = normalizedUrl;
            }
            else
            {
                // If we got empty string, iframe probably doesn't exist yet
                // Just set the currentUrl directly
                if (!url.StartsWith("http://") && !url.StartsWith("https://"))
                {
                    if (url.Contains(".") && !url.Contains(" "))
                    {
                        currentUrl = "https://" + url;
                    }
                    else
                    {
                        currentUrl = "https://www.google.com/search?q=" + Uri.EscapeDataString(url);
                    }
                }
                else
                {
                    currentUrl = url;
                }
                urlInput = currentUrl;
            }
        }
        catch (Exception ex)
        {
            showError = true;
            errorMessage = ex.Message;
            isLoading = false;
        }
        
        StateHasChanged();
#endif
    }
    
    [JSInvokable]
    public void OnIframeLoaded(string url)
    {
        isLoading = false;
        currentUrl = url;
        urlInput = url;
        StateHasChanged();
    }
    
    [JSInvokable]
    public void OnIframeError(string error)
    {
        isLoading = false;
        showError = true;
        errorMessage = error;
        StateHasChanged();
    }
    
    private async Task NavigateBack()
    {
#if ANDROID || IOS || MACCATALYST || WINDOWS
        if (safariService != null)
        {
            await safariService.NavigateBack();
            canGoBack = safariService.CanGoBack;
            canGoForward = safariService.CanGoForward;
            StateHasChanged();
        }
#else
        try
        {
            await JSRuntime.InvokeVoidAsync("safariInterop.navigateBack", "safari-iframe");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Navigate back error: {ex.Message}");
        }
#endif
    }
    
    private async Task NavigateForward()
    {
#if ANDROID || IOS || MACCATALYST || WINDOWS
        if (safariService != null)
        {
            await safariService.NavigateForward();
            canGoBack = safariService.CanGoBack;
            canGoForward = safariService.CanGoForward;
            StateHasChanged();
        }
#else
        try
        {
            await JSRuntime.InvokeVoidAsync("safariInterop.navigateForward", "safari-iframe");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Navigate forward error: {ex.Message}");
        }
#endif
    }
    
    private async Task Reload()
    {
        if (showPlaceholder)
            return;
            
        isLoading = true;
        
#if ANDROID || IOS || MACCATALYST || WINDOWS
        if (safariService != null)
        {
            await safariService.Reload();
        }
#else
        try
        {
            await JSRuntime.InvokeVoidAsync("safariInterop.reload", "safari-iframe");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Reload error: {ex.Message}");
            isLoading = false;
        }
#endif
        StateHasChanged();
    }
    
    private void ShowPlaceholder()
    {
        showPlaceholder = true;
        showError = false;
        currentUrl = "";
        urlInput = "";
    }
    
    private void ShowBookmarks()
    {
        // TODO: Implement bookmarks view
        Console.WriteLine("Bookmarks clicked");
    }
    
    private void ShowReadingList()
    {
        // TODO: Implement reading list
        Console.WriteLine("Reading list clicked");
    }
    
    private void ShowMore()
    {
        // TODO: Implement more options menu
        Console.WriteLine("More options clicked");
    }
    
    public async ValueTask DisposeAsync()
    {
        dotNetReference?.Dispose();
        
#if ANDROID || IOS || MACCATALYST || WINDOWS
        if (safariService != null)
        {
            safariService.NavigationCompleted -= OnMauiNavigationCompleted;
            safariService.NavigationFailed -= OnMauiNavigationFailed;
        }
#endif
        await Task.CompletedTask;
    }
}
