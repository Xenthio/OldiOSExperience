@using OldiOS.Shared.Models
@implements IResumableApp

@* iOS 5 Calculator App *@

<div class="calculator-app">
    <div class="calculator-display">
        <div class="display-value">@DisplayValue</div>
    </div>
    
    <div class="calculator-buttons">
        <div class="button-row">
            <button class="calc-button function" @onclick='() => HandleOperation("C")'>C</button>
            <button class="calc-button function" @onclick='() => HandleOperation("+/-")'>+/-</button>
            <button class="calc-button function" @onclick='() => HandleOperation("%")'>%</button>
            <button class="calc-button operator" @onclick='() => HandleOperation("÷")'>÷</button>
        </div>
        
        <div class="button-row">
            <button class="calc-button number" @onclick='() => HandleNumber("7")'>7</button>
            <button class="calc-button number" @onclick='() => HandleNumber("8")'>8</button>
            <button class="calc-button number" @onclick='() => HandleNumber("9")'>9</button>
            <button class="calc-button operator" @onclick='() => HandleOperation("×")'>×</button>
        </div>
        
        <div class="button-row">
            <button class="calc-button number" @onclick='() => HandleNumber("4")'>4</button>
            <button class="calc-button number" @onclick='() => HandleNumber("5")'>5</button>
            <button class="calc-button number" @onclick='() => HandleNumber("6")'>6</button>
            <button class="calc-button operator" @onclick='() => HandleOperation("-")'>-</button>
        </div>
        
        <div class="button-row">
            <button class="calc-button number" @onclick='() => HandleNumber("1")'>1</button>
            <button class="calc-button number" @onclick='() => HandleNumber("2")'>2</button>
            <button class="calc-button number" @onclick='() => HandleNumber("3")'>3</button>
            <button class="calc-button operator" @onclick='() => HandleOperation("+")'>+</button>
        </div>
        
        <div class="button-row">
            <button class="calc-button number zero" @onclick='() => HandleNumber("0")'>0</button>
            <button class="calc-button number" @onclick='() => HandleNumber(".")'>.</button>
            <button class="calc-button operator" @onclick='() => HandleOperation("=")'>=</button>
        </div>
    </div>
</div>

@code {
    private string DisplayValue = "0";
    private decimal CurrentValue = 0;
    private decimal StoredValue = 0;
    private string CurrentOperation = "";
    private bool NewNumber = true;
    
    // IResumableApp implementation
    public Dictionary<string, object> SaveState()
    {
        return new Dictionary<string, object>
        {
            { "DisplayValue", DisplayValue },
            { "CurrentValue", CurrentValue },
            { "StoredValue", StoredValue },
            { "CurrentOperation", CurrentOperation },
            { "NewNumber", NewNumber }
        };
    }
    
    public void RestoreState(Dictionary<string, object> state)
    {
        if (state.TryGetValue("DisplayValue", out var displayValue))
            DisplayValue = displayValue.ToString() ?? "0";
        
        if (state.TryGetValue("CurrentValue", out var currentValue))
            CurrentValue = Convert.ToDecimal(currentValue);
        
        if (state.TryGetValue("StoredValue", out var storedValue))
            StoredValue = Convert.ToDecimal(storedValue);
        
        if (state.TryGetValue("CurrentOperation", out var currentOperation))
            CurrentOperation = currentOperation.ToString() ?? "";
        
        if (state.TryGetValue("NewNumber", out var newNumber))
            NewNumber = Convert.ToBoolean(newNumber);
    }
    
    private void HandleNumber(string number)
    {
        if (NewNumber)
        {
            DisplayValue = number == "." ? "0." : number;
            NewNumber = false;
        }
        else
        {
            if (number == "." && DisplayValue.Contains("."))
                return;
            
            DisplayValue += number;
        }
    }
    
    private void HandleOperation(string operation)
    {
        CurrentValue = decimal.Parse(DisplayValue);
        
        switch (operation)
        {
            case "C":
                DisplayValue = "0";
                CurrentValue = 0;
                StoredValue = 0;
                CurrentOperation = "";
                NewNumber = true;
                break;
                
            case "+/-":
                CurrentValue *= -1;
                DisplayValue = CurrentValue.ToString();
                break;
                
            case "%":
                CurrentValue /= 100;
                DisplayValue = CurrentValue.ToString();
                break;
                
            case "=":
                PerformCalculation();
                CurrentOperation = "";
                NewNumber = true;
                break;
                
            default:
                if (!string.IsNullOrEmpty(CurrentOperation))
                {
                    PerformCalculation();
                }
                StoredValue = CurrentValue;
                CurrentOperation = operation;
                NewNumber = true;
                break;
        }
    }
    
    private void PerformCalculation()
    {
        decimal result = StoredValue;
        
        switch (CurrentOperation)
        {
            case "+":
                result = StoredValue + CurrentValue;
                break;
            case "-":
                result = StoredValue - CurrentValue;
                break;
            case "×":
                result = StoredValue * CurrentValue;
                break;
            case "÷":
                result = CurrentValue != 0 ? StoredValue / CurrentValue : 0;
                break;
        }
        
        DisplayValue = result.ToString();
        CurrentValue = result;
        StoredValue = result;
    }
}
